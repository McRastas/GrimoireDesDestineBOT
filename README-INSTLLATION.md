# üê≥ Installation Docker - Bot Discord Faer√ªn

Installation rapide avec Docker en utilisant le clone automatique du repository GitHub avec mise √† jour automatique au d√©marrage.

## üìã Pr√©requis

- Docker et Docker Compose install√©s
- Token Discord de votre bot (voir configuration Discord ci-dessous)
- (Optionnel) Acc√®s √† un Google Sheets public pour la boutique d'objets magiques

## ü§ñ Configuration Discord Developer Portal

Avant de d√©marrer, vous devez cr√©er et configurer votre bot sur Discord :

### 1. Cr√©er l'application Discord

1. Allez sur [Discord Developer Portal](https://discord.com/developers/applications)
2. Cliquez sur **"New Application"**
3. Donnez un nom √† votre bot (ex: "Bot Faer√ªn")
4. Acceptez les conditions et cr√©ez

### 2. Configurer le bot

1. Dans le menu de gauche, allez dans **"Bot"**
2. Cliquez sur **"Add Bot"** puis confirmez
3. **R√©cup√©rez votre Token** :
   - Cliquez sur **"Reset Token"** (ou **"Copy"** si c'est la premi√®re fois)
   - ‚ö†Ô∏è **GARDEZ CE TOKEN SECRET** - Ne le partagez jamais !
   - Sauvegardez-le pour le mettre dans le fichier `.env`

4. **Activez les intentions n√©cessaires** (scrollez vers le bas) :
   - ‚úÖ **Message Content Intent** (OBLIGATOIRE)
   > ‚ö†Ô∏è **IMPORTANT** : Sans "Message Content Intent", le bot ne pourra pas lire les messages pour d√©tecter les dates de qu√™tes !

### 3. R√©cup√©rer le Client ID

1. Dans le menu de gauche, allez dans **"OAuth2"** ‚Üí **"General"**
2. Copiez le **"CLIENT ID"** (sous Application ID)
3. Sauvegardez-le pour le mettre dans le fichier `.env`

### 4. Configurer les permissions d'installation

1. Allez dans **"Installation"**
2. Dans **"Installation Contexts"**, cochez **"Guild Install"** uniquement
3. Dans **"Default Install Settings"** ‚Üí **"Guild Install"** :
   
   **SCOPES** (obligatoires) :
   - `applications.commands` (pour les slash commands)
   - `bot` (pour le bot lui-m√™me)
   
   **PERMISSIONS** (strictement n√©cessaires) :
   - ‚úÖ `Send Messages` (Envoyer des messages)
   - ‚úÖ `Send Messages in Threads` (Envoyer des messages)
   - ‚úÖ `Embed Links` (Int√©grer des liens)
   - ‚úÖ `Read Message History` (Lire l'historique - pour d√©tecter les dates de qu√™tes)
   - ‚úÖ `Use Slash Commands` (Utiliser les commandes slash)
   - ‚úÖ `View Channels` (Envoyer des messages)

4. Sauvegardez les modifications

### 5. Inviter le bot sur votre serveur

1. Allez dans **"OAuth2"** ‚Üí **"URL Generator"**
2. Dans **SCOPES**, s√©lectionnez :
   - `applications.commands`
   - `bot`
3. Dans **BOT PERMISSIONS**, s√©lectionnez les m√™mes permissions que ci-dessus
4. Copiez l'URL g√©n√©r√©e en bas de page
5. Ouvrez cette URL dans votre navigateur et invitez le bot sur votre serveur

### 6. R√©cup√©rer le Guild ID (optionnel mais recommand√©)

Pour une synchronisation rapide des commandes :

1. Ouvrez Discord et activez le **Mode D√©veloppeur** :
   - Param√®tres utilisateur ‚Üí Avanc√©s ‚Üí Mode d√©veloppeur
2. Faites un clic droit sur votre serveur ‚Üí **"Copier l'identifiant du serveur"**
3. Sauvegardez cet ID pour le mettre dans `GUILD_ID` du fichier `.env`

> üí° Sans `GUILD_ID`, les commandes peuvent prendre jusqu'√† 1h pour appara√Ætre. Avec `GUILD_ID`, elles apparaissent instantan√©ment !

## üöÄ Installation

### 1. Cr√©er les fichiers Docker

Cr√©ez un dossier pour votre bot et ajoutez ces 3 fichiers :

#### `Dockerfile`
```dockerfile
FROM python:3.13-slim

LABEL maintainer="votre-email@example.com"
LABEL description="Bot Discord Faer√ªn - Calendrier D&D avec logs quotidiens"

ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

WORKDIR /app

# Installation de git + gcc
RUN apt-get update && apt-get install -y \
    git \
    gcc \
    && rm -rf /var/lib/apt/lists/*

# Variable d'environnement pour la branche (peut √™tre override)
ARG GIT_BRANCH=main
ENV GIT_BRANCH=${GIT_BRANCH}

# Clone automatique du repository en gardant .git
RUN git clone https://github.com/McRastas/GrimoireDesDestineBOT.git . && \
    git checkout ${GIT_BRANCH}

# Configuration Git pour √©viter les conflits de permissions
RUN git config --global --add safe.directory /app && \
    git config --global user.email "bot@faerun.local" && \
    git config --global user.name "Faerun Bot"

# Installation des d√©pendances Python
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt

# Cr√©er le r√©pertoire de logs avec les bonnes permissions
RUN mkdir -p /app/logs && \
    chmod 755 /app/logs

# Cr√©er utilisateur non-root
RUN groupadd -r botuser && useradd --no-log-init -r -g botuser botuser

# IMPORTANT : Donner les permissions sur tout /app Y COMPRIS .git
RUN chown -R botuser:botuser /app && \
    chmod -R u+w /app/.git

# Script simple pour update au d√©marrage
RUN echo '#!/bin/bash\ncd /app\ngit checkout $GIT_BRANCH 2>/dev/null || true\ngit pull origin $GIT_BRANCH 2>/dev/null || true\nexec "$@"' > /usr/local/bin/start.sh && \
    chmod +x /usr/local/bin/start.sh && \
    chown botuser:botuser /usr/local/bin/start.sh

# Changer vers l'utilisateur non-root
USER botuser

# Exposer le port web et d√©finir le volume de logs
EXPOSE 8080
VOLUME ["/app/logs"]

ENTRYPOINT ["/usr/local/bin/start.sh"]
CMD ["python", "main.py"]
```

#### `docker-compose.yml`
```yaml
services:
  faerun-bot:
    build: .
    container_name: faerun-bot
    restart: unless-stopped
    env_file:
      - .env
    ports:
      - "8080:8080"
    volumes:
      - ./logs:/app/logs
    environment:
      - GIT_DISCOVERY_ACROSS_FILESYSTEM=1
      - GIT_CONFIG_GLOBAL=/app/.gitconfig
      - GIT_BRANCH=${GIT_BRANCH:-main}  # Branche par d√©faut
```

#### `.env`
```env
# =================================
# CONFIGURATION BOT FAER√õN
# =================================

# Discord (OBLIGATOIRE - remplacez par vos vraies valeurs)
DISCORD_TOKEN=votre_token_discord_ici
CLIENT_ID=votre_client_id_ici

# Serveur Discord (OPTIONNEL)
GUILD_ID=votre_guild_id_pour_sync_rapide
ADMIN_ROLE_NAME=Fa√ßonneur

# Configuration des canaux (RECOMMAND√â)
CHANNELS_CONFIG={"recompenses":{"name":"recompenses"},"quetes":{"name":"d√©part-√†-l-aventure"},"logs":{"name":"log"},"admin":{"name":"bot-admin"}}

# Web Server (OPTIONNEL)
FLASK_HOST=0.0.0.0
FLASK_PORT=8080

# ============================================================================
# CONFIGURATION GOOGLE SHEETS (OPTIONNEL - Pour la commande /boutique)
# ============================================================================

# ID du Google Sheets (extrait de l'URL)
# URL: https://docs.google.com/spreadsheets/d/ID_ICI/edit
BOUTIQUE_SHEET_ID=votre_sheet_id_ici

# Nom de la feuille dans le Google Sheets
BOUTIQUE_SHEET_NAME=Objets Magique
BOUTIQUE_SHEET_GID=0

# Configuration des colonnes - AJUSTEZ selon vos noms de colonnes
BOUTIQUE_COL_NOM_FRANCAIS=NomVF
BOUTIQUE_COL_NOM_ANGLAIS=Nom en VO
BOUTIQUE_COL_TYPE=Type
BOUTIQUE_COL_RARITY=Raret√©
BOUTIQUE_COL_LIEN=Lien
BOUTIQUE_COL_SOURCE=Source
BOUTIQUE_COL_PRICE_ACHAT=OM_PRICE
BOUTIQUE_COL_PRIX=OM_PRICE

# Configuration de s√©lection
BOUTIQUE_MIN_ITEMS=3
BOUTIQUE_MAX_ITEMS=15
BOUTIQUE_EXCLUDED_RARITIES=L√©gendaire,Artefact
BOUTIQUE_RARITY_COLUMN=Raret√©
BOUTIQUE_REQUIRE_PRICE=
```

### 2. Configuration

#### Configuration minimale (Discord uniquement)

√âditez le fichier `.env` et remplacez avec les valeurs r√©cup√©r√©es du Discord Developer Portal :
- `votre_token_discord_ici` ‚Üí Le **Token** du bot (Section "Bot")
- `votre_client_id_ici` ‚Üí Le **Client ID** (Section "OAuth2" ‚Üí "General")
- `votre_guild_id_pour_sync_rapide` ‚Üí L'**ID de votre serveur** Discord (clic droit sur le serveur)

> üí° **Astuce** : Le `GUILD_ID` est optionnel mais fortement recommand√© pour que les commandes apparaissent instantan√©ment au lieu d'attendre 1h.

#### Configuration compl√®te (avec Google Sheets)

Si vous voulez utiliser la commande `/boutique` pour les objets magiques, ajoutez √©galement :
- `votre_sheet_id_ici` ‚Üí L'ID de votre Google Sheets (trouv√© dans l'URL)
- Ajustez les noms de colonnes selon votre feuille Google Sheets

**Pour trouver l'ID du Google Sheets :**
```
URL : https://docs.google.com/spreadsheets/d/1ABC123XYZ456/edit
ID  : 1ABC123XYZ456
```

### 3. D√©marrage

```bash
# Construire et d√©marrer le bot
docker compose up -d

# Voir les logs en temps r√©el
docker compose logs -f

# Arr√™ter le bot
docker compose down
```

## üîÑ Commandes Docker essentielles

### Build et gestion de l'image

```bash
# Builder l'image depuis le Dockerfile
docker build -t mon-bot-faerun .

# Builder avec une branche sp√©cifique
docker build --build-arg GIT_BRANCH=dev -t mon-bot-faerun:dev .

# Builder sans cache (si vous avez des probl√®mes)
docker build --no-cache -t mon-bot-faerun .
```

### Push sur Docker Hub (optionnel)

Si vous voulez partager votre image sur Docker Hub :

```bash
# Se connecter √† Docker Hub
docker login

# Taguer votre image avec votre nom d'utilisateur
docker tag mon-bot-faerun votre-username/nom-image:latest

# Pousser l'image
docker push votre-username/nom-image:latest
```

### Gestion du conteneur

```bash
# D√©marrer
docker compose up -d

# Arr√™ter
docker compose down

# Red√©marrer
docker compose restart

# Voir le statut
docker compose ps

# Voir les logs
docker compose logs -f

# Voir les logs depuis les 100 derni√®res lignes
docker compose logs --tail=100 -f
```

### Mise √† jour du bot

Le bot se met automatiquement √† jour depuis GitHub √† chaque red√©marrage !

```bash
# Simple red√©marrage (r√©cup√®re les derni√®res mises √† jour)
docker compose restart

# OU mise √† jour compl√®te avec rebuild
docker compose down
docker compose build --pull  # R√©cup√®re les derni√®res d√©pendances
docker compose up -d

# OU rebuild local complet
docker compose down
docker compose build --no-cache
docker compose up -d
```

### Debugging

```bash
# Entrer dans le conteneur pour d√©bugger
docker exec -it faerun-bot /bin/bash

# Voir l'utilisation des ressources
docker stats faerun-bot

# Inspecter le conteneur
docker inspect faerun-bot

# Voir les logs d'erreur uniquement
docker compose logs | grep -i error
```

### Nettoyage

```bash
# Nettoyer les conteneurs arr√™t√©s
docker container prune

# Nettoyer les images non utilis√©es
docker image prune

# Nettoyer tout (ATTENTION: supprime tout ce qui n'est pas utilis√©)
docker system prune -a

# Nettoyer et reconstruire compl√®tement
docker compose down
docker system prune -f
docker compose build --no-cache
docker compose up -d
```

## üìÅ Structure finale

Votre dossier doit contenir :
```
votre-dossier-bot/
‚îú‚îÄ‚îÄ Dockerfile
‚îú‚îÄ‚îÄ docker-compose.yml
‚îú‚îÄ‚îÄ .env
‚îî‚îÄ‚îÄ logs/                    # Cr√©√© automatiquement
    ‚îî‚îÄ‚îÄ bot_YYYY-MM-DD.log   # Logs quotidiens du bot
```

Le code du bot sera automatiquement t√©l√©charg√© depuis GitHub lors de la construction de l'image et mis √† jour √† chaque red√©marrage.

## üéØ Fonctionnalit√©s avanc√©es

### Changer de branche Git

Pour utiliser une branche de d√©veloppement :

```bash
# Dans .env, ajoutez :
GIT_BRANCH=dev

# Puis rebuild
docker compose down
docker compose build --no-cache
docker compose up -d
```

### Logs quotidiens

Les logs du bot sont automatiquement sauvegard√©s dans `./logs/` avec rotation quotidienne :
- Format : `bot_2025-09-30.log`
- Accessible depuis votre machine h√¥te
- Persistant m√™me si le conteneur est supprim√©

### Surveillance en temps r√©el

```bash
# Terminal 1 : Logs du bot
docker compose logs -f

# Terminal 2 : Ressources syst√®me
watch docker stats faerun-bot

# Terminal 3 : Logs applicatifs
tail -f ./logs/bot_$(date +%Y-%m-%d).log
```

## üîß R√©solution de probl√®mes

### Le bot ne d√©marre pas
```bash
# V√©rifier les logs
docker compose logs

# V√©rifier que le token Discord est correct dans .env
cat .env | grep DISCORD_TOKEN

# Reconstruire sans cache
docker compose down
docker compose build --no-cache
docker compose up -d
```

### Erreur de permissions Git
```bash
# Le script de d√©marrage g√®re automatiquement les permissions
# Si le probl√®me persiste, rebuild l'image
docker compose build --no-cache
```

### La commande /boutique ne fonctionne pas
```bash
# V√©rifier que toutes les variables Google Sheets sont d√©finies
cat .env | grep BOUTIQUE

# V√©rifier que votre Google Sheet est public
# Testez l'URL : https://docs.google.com/spreadsheets/d/VOTRE_ID/export?format=csv
```

### Les logs ne s'affichent pas
```bash
# V√©rifier les permissions du dossier logs
ls -la ./logs/

# V√©rifier que le volume est bien mont√©
docker inspect faerun-bot | grep -A 10 Mounts
```

## üìä Monitoring de production

### Healthcheck manuel
```bash
# Le bot expose un endpoint web sur le port 8080
curl http://localhost:8080

# V√©rifier que le bot Discord r√©pond
# Utilisez /test dans Discord
```

### Logs structur√©s
```bash
# Filtrer par niveau de log
docker compose logs | grep ERROR
docker compose logs | grep WARNING
docker compose logs | grep INFO

# Exporter les logs
docker compose logs > bot_logs_export.txt
```

## üÜò Besoin d'aide ?

- **Discord ne r√©pond pas** : V√©rifiez `docker compose logs` pour les erreurs de token
- **Commandes manquantes** : Assurez-vous que `GUILD_ID` est d√©fini pour une synchro rapide
- **Boutique inactive** : V√©rifiez que votre Google Sheet est public et que l'ID est correct
- **Probl√®mes de mise √† jour** : Faites `docker compose down && docker compose build --no-cache && docker compose up -d`

---

**Bon jeu dans les Royaumes Oubli√©s ! üêâ**

*Version : 2.0 - Mise √† jour septembre 2025*